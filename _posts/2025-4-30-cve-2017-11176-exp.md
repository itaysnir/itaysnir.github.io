---
layout: post
title: "CVE-2017-11176 - Linux Kernel Exploitation"
date: 2025-04-30 21:59:45 +0300
categories: jekyll update
---

**Contents**
* TOC
{:toc}
## Introduction

I've wrote this document in order to gain a deeper understanding of kernel exploitation. \
While there's a reference exploitation for kernel `2.6.32` within the following [link][ref-link], my goal is to apply the exploit for kernel `3.16.36`. 

## Setup

### VM Setup

Kernel 3.16.36 ISO: 

```bash
wget https://cdimage.debian.org/mirror/cdimage/archive/8.6.0-live/amd64/iso-hybrid/debian-live-8.6.0-amd64-standard.iso
```

I've default-installed the ISO using VMWare, with 1 CPU (easier debugging), `1GB RAM`, enabled SMEP and disabled kASLR & SMAP. \
The default credential for Debian-live is `user:live`. \
I've also verified SMEP is enabled and SMAP disabled by reading `/proc/cpuinfo`. Original `/proc/cmdline`:

```bash
BOOT_IMAGE=/boot/vmlinuz-3.16.0-4-amd64 root=UUID=3575d19c-e12f-4279-a054-3fd133416578 ro initrd=/install/initrd.gz quiet
```

To disable KASLR, I've added the following to `/etc/default/grub`:

```bash
GRUB_CMDLINE_LINUX_DEFAULT="quiet nokaslr nosmap"
GRUB_CMDLINE_LINUX="initrd=/install/initrd.gz"
$ update-grub
```

Within the `/boot` directory, we can see the `initrd.img`, `vmlinuz`, as well as the kernel's config file. The used allocator is SLAB:

```bash
CONFIG_SLAB=y
# CONFIG_SLUB is not set
# CONFIG_SLOB is not set
```

Upon rebooting, `/proc/cmdline` had the extra entries of `nokaslr, nosmap`. 

### Packages

We can download manually the required debian packages for kernel debugging, from the [snapshot debian packages][deb-packages]. 

```bash
uname -v
#1 SMP Debian 3.16.36-1+deb8u1 (2016-09-03)
```

In particular, `linux-image-3.16.0-4-amd64_3.16.36-1+deb8u1_amd64.deb` contains the actual kernel binary and modules. This installs bootable kernel (vmlinuz), kernel modules under `/lib/modules/$(uname -r)`, and initrd image under `/boot`. This is the minimum required to run the desired kernel. \
`linux-image-3.16.0-4-amd64-dbg_3.16.36-1+deb8u1_amd64.deb` (debug) - contains debugging symbols for the kernel, with DWARF symbols - and would make our lives easier using GDB. It stores the unstripped `vmlinux` within `/usr/lib/debug/boot/$(uname -r)`. \
`linux-headers-3.16.0-4-amd64_3.16.36-1+deb8u1_amd64.deb` - the kernel headers, required for module development. \
`linux-source-3.16_3.16.36-1+deb8u1_all.deb` - kernel source code, installs them under `/usr/src`. 

```bash
wget --no-check-certificate https://snapshot.debian.org/archive/debian-security/20160904T172241Z/pool/updates/main/l/linux/linux-image-3.16.0-4-amd64_3.16.36-1%2Bdeb8u1_amd64.deb
wget --no-check-certificate https://snapshot.debian.org/archive/debian-security/20160904T172241Z/pool/updates/main/l/linux/linux-image-3.16.0-4-amd64-dbg_3.16.36-1%2Bdeb8u1_amd64.deb
wget --no-check-certificate https://snapshot.debian.org/archive/debian-security/20160904T172241Z/pool/updates/main/l/linux/linux-headers-3.16.0-4-amd64_3.16.36-1%2Bdeb8u1_amd64.deb
wget --no-check-certificate https://snapshot.debian.org/archive/debian-security/20160904T172241Z/pool/updates/main/l/linux/linux-source-3.16_3.16.36-1%2Bdeb8u1_all.deb

dpkg -i linux-image-3.16.0-4-amd64_3.16.36-1+deb8u1_amd64.deb
dpkg -i linux-image-3.16.0-4-amd64-dbg_3.16.36-1+deb8u1_amd64.deb
dpkg -i linux-headers-3.16.0-4-amd64_3.16.36-1+deb8u1_amd64.deb
dpkg -i linux-source-3.16_3.16.36-1+deb8u1_all.deb
```

To support regular APT packages installation, I've set the archive debian as the sources-list, and ignored expiration dates:

```bash
# Within /etc/apt/sources.list
deb http://archive.debian.org/debian jessie main contrib non-free
deb-src http://archive.debian.org/debian jessie main contrib non-free

echo 'Acquire::Check-Valid-Until "false";' | sudo tee /etc/apt/apt.conf.d/99no-check-valid-until
```

Now, I could install some required packages: 

```bash
apt-get install -y gcc gdb bear binutils make systemtap`
```

### Compilation

I've compiled the exploit without any optimizations, and as PIC:

```bash
gcc -fpic -O0 -std=c99 -Wall -pthread ...
```

### Source Code

I've first re-built the kernel sources with bear, generating `compile-commands.json`, for Clangd to work properly. I've also disabled Microsoft C/C++ plugin, as they usually interfere. 

```bash
cd linux-source-dir/
make clean
make defconfig
bear -- make -j$(nproc)
```

I've set samba on the VM such that I'd be able to navigate within the shared sources from my host Windows machine. \




[ref-link]: https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part1.html
[deb-packages]: https://snapshot.debian.org/package/linux/3.16.36-1%2Bdeb8u1/
